# ESP32 S3 웹 기반 PLC 래더로직 편집기

## 개요

이 프로젝트는 **ESP32 S3** 마이크로컨트롤러를 기반으로 한 웹 기반 **PLC(Programmable Logic Controller)** 시스템입니다. AsyncWebServer와 WebSocket을 통해 웹 브라우저에서 래더로직을 실시간으로 편집, 실행, 저장 및 배포할 수 있습니다.

### 주요 특징
- 🌐 **웹 기반 UI**: 브라우저에서 래더로직 편집
- 📡 **실시간 통신**: WebSocket을 통한 양방향 통신
- 💾 **영구 저장**: LittleFS 파일시스템 및 Preferences로 설정 저장
- ⏱️ **타이머 지원**: TON, TOFF, TP 등 다양한 타이머 모드
- 🔢 **카운터**: 카운팅 기능
- 🎛️ **GPIO 제어**: LED, 릴레이 등 외부 장치 제어
- 🔄 **AP 모드**: WiFi 액세스포인트로 동작 (STA 모드도 지원)
- 💡 **실시간 상태 표시**: 활성 노드 및 주소값 실시간 표시
- 🔌 **가상 메모리**: M비트, D워드, I비트, Q비트 관리

---

## 하드웨어 요구사항

- **ESP32 S3 보드**
- **USB-C 케이블** (프로그래밍용)
- **LED** (옵션, GPIO 21에 연결 가능)
- **WiFi 연결** 가능한 환경

### 핀 배치

| 기능 | 핀 | 비고 |
|------|-----|------|
| LED (PLC 상태) | GPIO 21 | WS2812B 지원 |

---

## 설치 및 설정

### 1. 펌웨어 업로드

#### 필수 라이브러리
Arduino IDE에서 다음 라이브러리를 설치하세요:

```
- ArduinoJson (6.x 이상)
- AsyncTCP
- ESPAsyncWebServer
- FastLED
- LittleFS
```

#### 업로드 단계

1. Arduino IDE 열기
2. **보드 설정**: `ESP32S3 Dev Module` 선택
3. **포트**: 연결된 COM 포트 선택
4. `WEB_PLC.ino` 파일 열기
5. **업로드** 버튼 클릭

### 2. WiFi 설정

[WEB_PLC.ino](WEB_PLC.ino) 파일 상단의 설정 섹션에서:

```cpp
#define WIFI_SSID "ESP32_WEB_PLC"      // AP 모드 SSID
#define WIFI_PASSWORD "12345678"        // AP 모드 비밀번호
```

---

## 사용 방법

### 웹 인터페이스 접속

1. **ESP32 부팅** 후 WiFi 네트워크 목록에서 `ESP32_WEB_PLC` 접속
2. 브라우저에서 `http://192.168.4.1` 접속
3. 래더로직 편집 화면 로드

### 기본 UI 구성

```
┌─────────────────────────────────────────────────┐
│ [RUN] [STOP] [ERROR] [RESET] [메뉴] [배포]      │  상단 바
├──────────────────────────────────────────────────┤
│                                                  │
│ [팔레트]      [편집 영역 - 그리드]                 │
│                                                  │
│ - OPEN       • 노드 드래그로 배치                  │
│ - CLOSE      • 우클릭 노드 삭제                    │
│ - SET        • 연결선 자동 배치                    │
│ - RESET      │                                  │
│ ...          │                                  │
└──────────────────────────────────────────────────┘
```

### 상태 버튼

| 버튼 | 기능 | 설명 |
|------|------|------|
| **RUN** | 래더로직 실행 | PLC 스캔 루프 시작, 주소값 갱신 |
| **STOP** | 래더로직 정지 | 스캔 중단, 출력값 유지 |
| **ERROR** | 에러 상태 | (자동 또는 수동 설정) |
| **RESET** | 초기화 | 모든 메모리, 타이머 초기화 |
| **배포** | 펌웨어 저장 | 현재 로직을 ESP32에 저장 |

### 노드 타입

#### 입력 노드 (상좌측)
- **OPEN**: 상시 ON 접점
- **CLOSE**: 상시 OFF 접점  
- **RISING**: 상승 엣지 감지
- **FALLING**: 하강 엣지 감지
- **INVERT**: 반전 접점

#### 출력 노드 (상우측)
- **COIL**: 메모리 비트 제어
- **SET**: 메모리 비트 강제 ON
- **RESET**: 메모리 비트 강제 OFF

#### 특수 노드
- **INSTRUCTION**: 명령어 실행 (타이머, 카운터, 산술 등)
- **NETWORK**: 네트워크 간 연결 및 병렬/직렬 구성

---

## 명령어 (Instructions)

### 타이머

#### TON (On-Delay Timer)
입력이 ON되면 설정된 시간 후 출력이 ON됨

```
명령어: TON
주소: T0 (T0~T99)
Set Point: 1000 (밀리초)
Args: (비워두기)
```

#### TOFF (Off-Delay Timer)
입력이 OFF되면 설정된 시간 후 출력이 OFF됨

```
명령어: TOFF
주소: T1
Set Point: 500
```

#### TP (Pulse Timer)
입력 펄스 동안 설정된 시간 만큼 출력 ON

```
명령어: TP
주소: T2
Set Point: 2000
```

### 카운터

#### COUNT (상향 카운터)
입력 엣지마다 1 증가, Set Point 도달 시 Q 출력 ON

```
명령어: COUNT
주소: C0 (C0~C99)
Set Point: 10 (기본값)
```

#### RESET (카운터 리셋)
지정된 카운터를 0으로 초기화

```
명령어: RESET
주소: C0
```

### 산술 연산

#### ADD (더하기)
```
명령어: ADD
주소: D0 (D0~D99 데이터 워드)
Args: 5
→ D0 = D0 + 5
```

#### SUB (빼기)
```
명령어: SUB
주소: D0
Args: 3
→ D0 = D0 - 3
```

#### MUL (곱하기)
```
명령어: MUL
주소: D0
Args: 2
→ D0 = D0 * 2
```

#### DIV (나누기)
```
명령어: DIV
주소: D0
Args: 2
→ D0 = D0 / 2
```

#### MOV (데이터 이동)
```
명령어: MOV
주소: D0
Args: 100
→ D0 = 100
```

### 로직 제어

#### NOP (No Operation)
아무것도 실행하지 않음 (플레이스홀더)

```
명령어: NOP
```

#### HLT (Halt)
PLC 실행 중지

```
명령어: HLT
```

---

## 메모리 주소 체계

### 비트 메모리

| 주소 | 범위 | 설명 |
|------|------|------|
| **M0-M199** | 0~199 | 범용 메모리 비트 |
| **I0-I99** | 0~99 | 입력 비트 (읽기 전용) |
| **Q0-Q99** | 0~99 | 출력 비트 |
| **T0-T99** | 0~99 | 타이머 (읽기: 경과시간, 쓰기: Set Point) |
| **C0-C99** | 0~99 | 카운터 (읽기: 현재값, 쓰기: Set Point) |

### 워드 메모리

| 주소 | 범위 | 설명 |
|------|------|------|
| **D0-D99** | 0~99 | 32비트 데이터 워드 (정수, 0~4,294,967,295) |

### 사용 예시

```
M0 = 범용 메모리 비트 0
I5 = 입력 비트 5
Q10 = 출력 비트 10
T0 = 타이머 0
C1 = 카운터 1
D5 = 데이터 워드 5 (32비트 정수)
```

---

## 로직 저장 및 배포

### 자동 저장
- 노드 추가/삭제/편집 시 자동으로 브라우저 로컬스토리지에 저장

### 수동 배포

1. **배포 버튼** 클릭
2. 현재 로직이 JSON 형식으로 ESP32에 저장
3. 재부팅 후에도 로직 유지 (LittleFS)

### 로직 파일 형식

로직은 JSON으로 저장됨:

```json
{
  "nodes": [
    {
      "id": 0,
      "type": "NODE_OPEN",
      "addr": "M0",
      "tag": "Start",
      "x": 100,
      "y": 100
    },
    {
      "id": 1,
      "type": "NODE_COIL",
      "addr": "Q0",
      "tag": "LED",
      "x": 300,
      "y": 100
    }
  ],
  "links": [
    {
      "fromNode": 0,
      "toNode": 1,
      "fromPort": "R",
      "toPort": "L"
    }
  ]
}
```

---

## PLC 스캔 주기

- **기본 스캔 간격**: 10ms (약 100Hz)
- **상태 업데이트**: 200ms (5Hz) - 성능 최적화
- **실시간 모니터링**: 모든 활성 노드 실시간 추적

---

## 트러블슈팅

### 1. 웹 인터페이스에 접속할 수 없음

**증상**: `http://192.168.4.1` 로 접속 불가

**해결책**:
- ESP32가 AP 모드인지 확인 (`WIFI_SSID` 네트워크 있는지 확인)
- 시리얼 모니터에서 부팅 메시지 확인
- 보드 리셋 (RST 버튼 3초 이상 누르기)

### 2. 로직이 실행되지 않음

**증상**: RUN 버튼이 작동하지 않음

**해결책**:
- 시리얼 모니터에서 `[ERROR]` 메시지 확인
- 노드 연결 상태 확인 (모든 노드가 연결되어 있는지)
- RESET 버튼으로 초기화 후 다시 시도

### 3. 타이머/카운터가 동작하지 않음

**증상**: 명령어를 추가했으나 동작 없음

**해결책**:
- 명령어 이름을 정확히 입력했는지 확인 (대소문자 구분)
- Set Point 값이 0이 아닌지 확인
- 입력 신호가 올바른지 확인

### 4. 배포 후 로직이 사라짐

**증상**: 재부팅 후 로직이 초기화됨

**해결책**:
- **배포 버튼**을 반드시 클릭해야 저장됨 (자동 저장은 브라우저에만)
- 배포 완료 후 시리얼 모니터에서 "Logic saved" 메시지 확인

---

## 개발 정보

### 파일 구조

```
/workspaces/PLC/
├── WEB_PLC.ino          # 메인 펌웨어
├── index.html           # 웹 UI 인터페이스
└── README.md            # 이 파일
```

### 주요 함수

#### 메모리 관리
- `getMBit(String addr)` - M비트 읽기
- `setMBit(String addr, bool value)` - M비트 쓰기
- `getDWord(String addr)` - D워드 읽기
- `setDWord(String addr, uint32_t value)` - D워드 쓰기

#### 로직 실행
- `executeLogic()` - 래더로직 메인 루프
- `evaluateNode(int nodeId)` - 개별 노드 평가
- `processTimers()` - 타이머 처리
- `processCounters()` - 카운터 처리

#### 웹 통신
- `onWsEvent()` - WebSocket 이벤트 핸들러
- `sendPlcStatus()` - 상태 업데이트 전송
- `loadLogic()` - 로직 로드
- `saveLogic()` - 로직 저장

### API 엔드포인트

#### REST API

| 메서드 | 엔드포인트 | 설명 |
|--------|-----------|------|
| GET | `/api/status` | PLC 상태 조회 |
| GET | `/api/logic` | 현재 로직 조회 |
| POST | `/api/logic` | 로직 저장 |
| POST | `/api/reset` | PLC 초기화 |
| GET | `/api/memory` | 메모리 상태 조회 |

#### WebSocket (`/ws`)

**메시지 형식**: JSON

```json
{
  "type": "status",
  "data": {
    "plcStatus": "RUN",
    "nodes": [...],
    "memory": {...}
  }
}
```

---

## 라이선스

MIT License

---

## 지원 및 문의

- GitHub Issues에서 버그 보고
- 기술 문의는 시리얼 모니터 로그 메시지 확인

---

## 버전 히스토리

### v1.0 (2026-01-13)
- 초기 릴리스
- 래더로직 편집 및 실행 기능
- 타이머, 카운터, 산술 연산 지원
- 웹 기반 실시간 모니터링

---

**마지막 업데이트**: 2026-01-13
